<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- For Mobile Devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta name="generator" content="Doxygen 1.8.11"/>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <link rel="stylesheet" href='http://fonts.googleapis.com/css?family=Exo+2:400,200,700' type='text/css'>
    <title>Project Chrono: Cosimulation with Simulink (demo_cosim_hydraulics.cpp)</title>
    <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
    <script type="text/javascript" src="dynsections.js"></script>
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
    <link href="main.css" rel="stylesheet" type="text/css" />
    <!--  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css"> -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="doxy-boot.js"></script>
    <script type="text/javascript" src="bootstrap-hover-dropdown.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://projectchrono.org">
            <span class="logo first">PROJECT</span><span class="logo second">CHRONO</span>
        </a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="http://projectchrono.org/download">Download</a></li>
        <li class="dropdown">
            <a href="http://api.chrono.projectchrono.org" class="dropdown-toggle disabled" data-hover="dropdown" data-toggle="dropdown" data-delay="100" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li><a href="http://api.chrono.projectchrono.org/faq_root.html">FAQ</a></li>
                <li><a href="http://api.chrono.projectchrono.org/tutorial_table_of_content_install.html">Install Guide</a></li>
                <li><a href="http://api.chrono.projectchrono.org/tutorial_root.html">Examples/Tutorials</a></li>
                <li><a href="http://api.chrono.projectchrono.org/model_root.html">Model Library</a></li>
                <li><a href="http://api.chrono.projectchrono.org/validation_studies_root.html">Validation Studies</a></li>
                <li><a href="http://api.chrono.projectchrono.org/whitepaper_root.html">White Papers</a></li>
                <li><a href="http://projectchrono.org/docpdf">PDF Version</a></li>
            </ul>
        </li>
        <li class="dropdown">
            <a href="http://projectchrono.org/gallery/" class="dropdown-toggle disabled" data-hover="dropdown" data-toggle="dropdown" data-delay="100" role="button" style="dropdown:hover" aria-haspopup="true" aria-expanded="false">Movies <span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li><a href="http://projectchrono.org/gallery/">Gallery</a></li>
                <li><a href="http://sbel.wisc.edu/Animations/">SBEL</a></li>
                <li><a href="https://vimeo.com/uwsbel">On Vimeo</a></li>
            </ul>
        </li>
        <li><a href="http://projectchrono.org/news/">News</a></li>
        <li><a href="http://projectchrono.org/forum">Forum</a></li>
		<li class="dropdown">
            <a href="http://projectchrono.org/about/" class="dropdown-toggle disabled" data-hover="dropdown" data-toggle="dropdown" data-delay="100" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li><a href="http://projectchrono.org/about/">What is ProjectChrono</a></li>
                <li><a href="http://projectchrono.org/testimonials/">Users</a></li>
            </ul>
        </li>
        <li><a href="http://projectchrono.org/status">Status</a></li>            
            <li>
              <form method="get" action="http://projectchrono.org/search" id="search_bar_triggered">
                          <input type="submit" value="Search">
                <input type="text" id="search_bar" name="query" value="" />
              </form> 
            </li>
    </ul>
          <!-- <ul class="nav navbar-nav navbar-right">
      </ul> -->
  </div><!--/.navbar-collapse -->
</div>
</nav>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
    <div class="content" id="content">
        <div class="container">
            <div class="row">
                <div class="col-sm-12 panel panel-default" style="padding-bottom: 15px;">
                    <div style="margin-bottom: 15px;">
                        <!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">Project Chrono API/SDK documentation</a></li><li class="navelem"><a class="el" href="manual_root.html">Reference Manual</a></li><li class="navelem"><a class="el" href="tutorial_root.html">Tutorials</a></li><li class="navelem"><a class="el" href="tutorial_table_of_content_chrono_cosimulation.html">Chrono COSIMULATION module tutorials</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Cosimulation with Simulink (demo_cosim_hydraulics.cpp) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial explains how to use co-simulation to simulate a hydraulic system that moves a simple mechanism. The hydraulic system is managed by Simulink, while the mechanism with moving parts and joints is simulated by Chrono. This is enabled by the <a class="el" href="module_cosimulation_installation.html">COSIMULATION module</a>.</p>
<p>The approach described can serve as a template for complex scenarios in which mechanisms with multiple hydraulic cylinders actuate moving parts. In general, Simulink features are used for hydraulic subsystem simulation and controls, whereas Chrono can be used for the remaining components of the mechanical system:</p>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_01.png" />
</div>
<h1>Prerequisites</h1>
<p>The prerequisites for this tutorial are:</p>
<ul>
<li>The Chrono <a class="el" href="module_cosimulation_installation.html">COSIMULATION module</a> should be properly installed/working.</li>
<li><a href="http://www.mathworks.com/products/simulink">Simulink</a> must be installed.</li>
<li>The Matlab <a href="http://www.mathworks.com/products/instrument">Instrument Control Toolbox</a> should be installed.</li>
<li>The Matlab <a href="http://www.mathworks.com/products/simhydraulics">SimHydraulics Toolbox</a> should be installed.</li>
</ul>
<div class="ce-info"> SimHydraulics is an optional Matlab toolbox for Simulink. This specific Chrono demo requires it yet other examples of cosimulation might not necessarily need it. </div><h1>Background</h1>
<p>Two way co-simulation draws on two simulation tools which simultaneously simulate (advance in time) the two subsystems in which the original system is partitioned. Once in a while the two solvers (simulation tools) synchronize to exchange data after which they proceed independently until the next synchronization time. This periodic data synchronization is necessary because the subsystems are coupled. For tightly coupled subsystems the synchronization happens very often.</p>
<p>There are many approaches to co-simulation. The method described in this tutorial is quite simple - it is based on the following pattern of interaction between Chrono and Simulink:</p>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_02.png" />
</div>
<p>In the schematic above, suppose that the system is defined by variables \( \mathbf{X} = \{ \mathbf{X}_{CE}, \mathbf{X}_{S}\} \), which are splitted so that Chrono deals with \( \mathbf{X}_{CE} \) while Simulink deals with \( \mathbf{X}_{S} \).</p>
<p>The sequence of operations is:</p><ul>
<li>A) the Chrono simulator advances by a time step \( dt \), up to the synchronization point;</li>
<li>B) the \( \mathbf{X}_{CE} \) variables are sent from Chrono to Simulink using a TCP/IP socket;</li>
<li>C) the \( \mathbf{X}_{S} \) variables are sent from Simulink to Chrono using a TCP/IP socket;</li>
<li>D) the Simulink simulation advances up to the synchronization point. Note that Simulink could use variable-step integration, hence it could take more than one step to reach the synchronization point, see figure.</li>
</ul>
<p>This pattern is repeated through to the end of the simulation.</p>
<p>In this implementation, the value of \( \mathbf{X}_{CE} \) that is received by Simulink is interpolated linearly during the timestep(s) advancement that reaches the sync time; on the other hand, the \( \mathbf{X}_{S} \) values received by Chrono are kept constant as in a Zero Order Hold (ZOH).</p>
<p>In this type of cosimulation the 'slow' integrator, that is Chrono, precedes the high-frequency integrator, that is Simulink. However, the opposite could be done as well. Other more sophisticated interpolation-extrapolation concepts could be devised - for example using extrapolation instead of ZOH or using higher-order interpolation for \( \mathbf{X}_{CE} \) received in Simulink.</p>
<p>When Chrono precedes Simulink and using extrapolated \( \mathbf{X}_{S} \) values is like having a latency of \( dt \) in the cause-effect relationship between Chrono and Simulink. When the coupling between the two subsystems is tight, too large a \( dt \) can cause <em>numerical instability</em> problems. Unfortunately, keeping \( dt \) very small to address stability issues will likely impact negatively the simulation times.</p>
<h1>The system</h1>
<p>The following mechanism is considered in this tutorial: a lever with a revolute joint in A and a linear actuator L between points B and D:</p>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_03.png" />
</div>
<p>Although Chrono already has methods to define linear actuators, Simulink and its SimHydraulics toolbox are used to produce an advanced model of a hydraulic actuator with valves, piping, pumps, feedback control, etc. The yellow actuator will be simulated in Simulink, the rest in Chrono.</p>
<h1>The Simulink model</h1>
<p>First, open Simulink and create a model of a hydraulic actuator with a pump and a valve. To keep it simple, just load the <em>Power assisted steering mechanism</em> demo of SimHydraulics (sh_hydraulic_power_assisted_steering.mdl). It includes a ready-to use system where a piston is moved back and forth depending on the feedback control of the rotation of a steering wheel:</p>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_04.png" />
</div>
<p>Note that the original example used a mass-spring-damper system modeled with SimScape Simulink blocks; this can be seen by double clicking on the <em>Load</em> block to expand it:</p>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_05.png" />
</div>
<p>Replacing the <em>Load</em> block with a Chrono mechanical load calls for the following steps:</p>
<ul>
<li>Delete the <em>Load</em> block.</li>
<li>Open data/cosimulation/CEcosimulation.mdl, copy the <em>CoSimulate</em> block and paste it into the model, near the piston.</li>
<li>Select <em>CoSimulate</em> and use menu Edit/Link Options../Break link so that you can modify it</li>
<li>Create the following connections between the piston and the <em>CoSimulate</em> block:</li>
</ul>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_06.png" />
</div>
<p>The <em>CoSimulate</em> block is an interface that sends its input vector of variables to Chrono and gets back an output vector at fixed time intervals. Specifically,</p><ul>
<li>Simulink sends the force of the piston to Chrono. Chrono will apply that force to the mechanical system between the 'B' and 'D' hinges, so it will compute speed and displacement.</li>
<li>Vice-versa: Chrono sends speed &amp; displacement of the piston to Simulink. Simulink will enforce that speed and displacement to the piston so that it will compute the force.</li>
</ul>
<p>This explains the need for those two yellow blocks: one is the SimScape Simulink block used to get a reaction force (in this example in the rod of the piston) while the other is used to impose a motion (in this example to the rod of the piston). The PS S and S PS grey blocks are used to convert SimScape and SimHydraulics signals from/to Simulink signals.</p>
<div class="ce-info"> Note that there could be other ways to do co-simulation for this example. For instance, one could impose a force in Simulink and send displacement information to Chrono, then Chrono imposes displacement with a rheonomic linear actuator and gets the reaction force to send to Simulink. </div><p>Double click on the <em>CoSimulate</em> block and set its parameters:</p>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_07.png" />
</div>
<p>Semantics:</p>
<ul>
<li><em>Communication step size</em>: controls how frequently Chrono and Simulink exchange information. This example needs a very small step size because this is a stiff problem (as is often the case with hydraulic problems) so larger steps would cause numerical stability issues.</li>
<li><em>N. of scalars received from Chrono</em> must match the number of variables sent from the Chrono-side using C++. In this example what gets sent is 1) velocity and 2) displacement of the rod.</li>
<li><em>TCP host name</em>: leave 'localhost' if you run both simulators on the same computer, otherwise if you have Chrono on a different machine, you provide the IP address here.</li>
<li><em>TCP port</em>: any non-firewalled, non-used port can work here. For instance, use 50009.</li>
<li><em>TCP timeout</em>: if Chrono does not respond within this period, the simulation is stopped.</li>
</ul>
<p>Next, save the entire model with a proper name. This example already provides a ready-to-use model: data/cosimulation/test_cosim_hydraulics.mdl</p>
<h1>The Chrono model</h1>
<p>Now let's develop the Chrono C++ program that will interact with Simulink. You can find a ready-to-use example in src/demos/cosimulation/demo_cosim_hydraulics.cpp</p>
<ul>
<li>Use the 'try...catch' statements around socket communication operations because errors in sockets might throw exceptions</li>
<li>create a Chsystem and populate it with a truss, a moving body, and a revolute joint:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">try</span>{</div><div class="line"></div><div class="line">        ChSystem my_system; </div><div class="line"></div><div class="line"><span class="comment">// Create rigid bodies and add them to the system:</span></div><div class="line"><span class="keyword">auto</span> my_body_A = std::make_shared&lt;ChBody&gt;();  <span class="comment">// truss</span></div><div class="line">my_body_A-&gt;SetBodyFixed(<span class="keyword">true</span>);                <span class="comment">// truss does not move!</span></div><div class="line">my_system.<a class="code" href="classchrono_1_1_ch_assembly.html#aeb86b4df59dc82ad4d5a969b45e159b1">AddBody</a>(my_body_A);</div><div class="line"></div><div class="line"><span class="keyword">auto</span> my_body_B = std::make_shared&lt;ChBody&gt;();  <span class="comment">// moving body</span></div><div class="line">my_body_B-&gt;SetMass(114);</div><div class="line">my_body_B-&gt;SetInertiaXX(ChVector&lt;&gt;(50, 50, 50));</div><div class="line">my_body_B-&gt;SetPos(ChVector&lt;&gt;(1, 1, 0));</div><div class="line">my_system.AddBody(my_body_B);</div><div class="line"></div><div class="line"><span class="comment">// Now create a mechanical link; i.e., a revolute joint at (0,0,0),</span></div><div class="line"><span class="comment">// between these two markers and insert in system:</span></div><div class="line"><span class="keyword">auto</span> my_link_BA = std::make_shared&lt;ChLinkLockRevolute&gt;();</div><div class="line">my_link_BA-&gt;Initialize(my_body_B, my_body_A, ChCoordsys&lt;&gt;(ChVector&lt;&gt;(0, 1, 0)));</div><div class="line">my_system.AddLink(my_link_BA);</div></div><!-- fragment --><p>Now create create a 'dead' linear actuator between two points using a ChLinkSpring with zero stiffness and damping. This will be used to apply the force between the two bodies as a cylinder with spherical ball ends.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> my_link_actuator = std::make_shared&lt;ChLinkSpring&gt;();</div><div class="line">my_link_actuator-&gt;Initialize(my_body_B, my_body_A, <span class="keyword">false</span>, ChVector&lt;&gt;(1, 0, 0), ChVector&lt;&gt;(1, 1, 0));</div><div class="line">my_link_actuator-&gt;Set_SpringK(0);</div><div class="line">my_link_actuator-&gt;Set_SpringR(0);</div><div class="line">my_link_actuator-&gt;Set_SpringRestLength(my_link_actuator-&gt;GetDist());</div><div class="line">my_system.AddLink(my_link_actuator);</div></div><!-- fragment --><p>Create a spring-damper to have some load when moving, and configure the system's solver precision:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> my_link_springdamper = std::make_shared&lt;ChLinkSpring&gt;();</div><div class="line">my_link_springdamper-&gt;Initialize(my_body_B, my_body_A, <span class="keyword">false</span>, ChVector&lt;&gt;(1, 0, 0), ChVector&lt;&gt;(1, 1, 0));</div><div class="line">my_link_springdamper-&gt;Set_SpringK(4450);</div><div class="line">my_link_springdamper-&gt;Set_SpringR(284);</div><div class="line">my_link_springdamper-&gt;Set_SpringRestLength(my_link_springdamper-&gt;GetDist());</div><div class="line">my_system.AddLink(my_link_springdamper);</div><div class="line"></div><div class="line">my_system.Set_G_acc(ChVector&lt;&gt;(0, 0, 0));</div><div class="line">my_system.SetMaxItersSolverSpeed(20);</div><div class="line">my_system.SetSolverType(ChSystem::SOLVER_BARZILAIBORWEIN);</div></div><!-- fragment --><p>Add a socket framework object (a unique copy to be used through all the program) and a cosimulation interface:</p>
<div class="fragment"><div class="line"><span class="comment">// Add a socket framework object</span></div><div class="line">ChSocketFramework socket_tools;</div><div class="line"></div><div class="line"><span class="comment">// Create the cosimulation interface:</span></div><div class="line">ChCosimulation cosimul_interface(socket_tools,</div><div class="line">                                 1,   <span class="comment">// n.input values from Simulink</span></div><div class="line">                                 2);  <span class="comment">// n.output values to Simulink</span></div></div><!-- fragment --><p>Prepare the two column vectors of data that will be swapped back and forth between Chrono and Simulink:</p>
<ul>
<li>receive one variable from Simulink (the hydraulic cylinder force)</li>
<li>send two variables to Simulink (the hydraulic cylinder velocity and displacement)</li>
</ul>
<div class="fragment"><div class="line">ChMatrixDynamic&lt;double&gt; data_in(1,1);</div><div class="line">ChMatrixDynamic&lt;double&gt; data_out(2,1);</div></div><!-- fragment --><p>Wait for client (Simulink) to connect. Note that in this implementation Chrono is the server, and Simulink the client.</p>
<div class="fragment"><div class="line"><a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot; *** Waiting Simulink to start... *** \n\n&quot;</span>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> PORTNUM = 50009;</div><div class="line"></div><div class="line">cosimul_interface.WaitConnection(PORTNUM);</div></div><!-- fragment --><p>Upon establishing a connection, the simulation is ready to begin. Note that 'dt' must be the same with the value entered in the CEcosimulation block</p>
<div class="fragment"><div class="line">        <span class="keywordtype">double</span> mytime = 0;</div><div class="line">        <span class="keywordtype">double</span> histime = 0;</div><div class="line"></div><div class="line">        <span class="keywordtype">double</span> dt = 0.001; <span class="comment">// same as sample period</span></div><div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">        {</div><div class="line"></div><div class="line">                <span class="comment">// A) -- ADVANCE THE Chrono SIMULATION                                  </span></div><div class="line">                <span class="keywordflow">if</span> (dt&gt;0)</div><div class="line">                        my_system.DoStepDynamics(dt);</div><div class="line"></div><div class="line">                mytime += dt;                   </div><div class="line"></div><div class="line">                <span class="comment">// B) -- SYNCHRONIZATION                        </span></div><div class="line">                        <span class="comment">// B.1) - SEND data </span></div><div class="line"></div><div class="line">                <span class="comment">// - Set the Chrono variables into the vector that must </span></div><div class="line">                <span class="comment">//   be sent to Simulink at the next timestep:</span></div><div class="line">                <span class="comment">//      * the velocity of the hydraulic actuator</span></div><div class="line">                <span class="comment">//      * the displacement of the hydraulic actuator</span></div><div class="line"></div><div class="line">                data_out(0) = my_link_actuator-&gt;GetDist_dt();</div><div class="line">                data_out(1) = my_link_actuator-&gt;GetDist() - my_link_actuator-&gt;Get_SpringRestLenght(); </div><div class="line"></div><div class="line">                cosimul_interface.SendData(mytime, &amp;data_out);  </div><div class="line"></div><div class="line"></div><div class="line">                        <span class="comment">// B.2) - RECEIVE data</span></div><div class="line">                cosimul_interface.ReceiveData(histime, &amp;data_in);</div><div class="line"></div><div class="line">                <span class="comment">// - Update the Chrono system with the received force  </span></div><div class="line">                <span class="comment">//   from Simulink, using the data_in vector, which contains:</span></div><div class="line">                <span class="comment">//      * the force of the hydraulic actuator</span></div><div class="line"></div><div class="line">                my_link_actuator-&gt;Set_SpringF(data_in(0));</div><div class="line"></div><div class="line"></div><div class="line">                <a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot;--- time: &quot;</span> &lt;&lt; mytime &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;             </div><div class="line"></div><div class="line">        }</div><div class="line"></div><div class="line">} </div></div><!-- fragment --><p>Finally, provision for exception catching in running into any trouble with the socket connection.</p>
<div class="fragment"><div class="line"><span class="keywordflow">catch</span>(ChExceptionSocket exception)</div><div class="line">{</div><div class="line">        <a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot; ERRROR with socket: \n&quot;</span> &lt;&lt; exception.what() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line">}</div></div><!-- fragment --><h1>Run the cosimulation</h1>
<p>All the tools are ready for the cosimulation at this point. The next steps:</p>
<ul>
<li>Compile the Chrono program;</li>
<li>Run the Chrono program; it will enter a wait state, because it is waiting Simulink to connect;</li>
<li>Open the ''Input/Output'' orange scope block in Simulink, simply to plot some results.</li>
<li>Run the Simulink model by pressing the '&gt;' button in the Simulink interface;</li>
</ul>
<p>The two codes will run in parallel and will exchange data periodically up to the end of the simulation or up to when one presses 'stop' or aborts the Chrono program.</p>
<div class="image">
<img src="http://projectchrono.org/assets/manual/Tutorial_cosim_hydraulics_08.png" />
</div>
<h1>Notes</h1>
<div class="ce-info"> Co-simulation can be slow if the communication timestep is small. In some cases a small timestep is unavoidable - in the example discussed here this is necessary because the system is stiff and larger steps would cause a numerical instability that will see the variables oscillating wildly. </div><div class="ce-info"> One can configure the ''CoSimulate'' block with more than one input and two outputs. For instance, if you are going to simulate six PID controllers for a 6 DOF robot using Simulink, you might need to receive six rotations from Chrono as output and send six control signals (ex. torques) to Chrono, as input of CoSimulate. </div><div class="ce-warning"> Only a single ''CoSimulate'' block can be used at a time. If you need to send/receive a larger number of variables, simply configure the block to have vectors with more elements as input and outputs. </div><div class="ce-info"> The input and output signals of the 'CoSimulate' block accepts vectors. To build a vector from single signals use the 'Mux' block in Simulink. To split a vector in single signals use a 'De-Mux' block as shown in the example above. </div><div class="ce-info"> If you have multiple options for choosing where to split a system in two subsystems for cosimulation, keep in mind this rule of thumb: split in a place where the connecting variables (forces, displacements or such) experience 'low frequencies' rather than high frequencies because the higher the frequencies that flow in the interface, the smaller the communication step must be. </div><div class="ce-info"> Changing the Simulink integrator from variable time step to fixed time step might yield a warning or error about blocks having different sample rates. Use the menu Simulation/Configuration parameters..., go to the Solver tab, then set 'Tasking mode for periodic sample times: SingleTasking' (default is Auto). </div><h1>The entire code</h1>
<div class="fragment"><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//   Advanced demo showing how to implement a cosimulation</span></div><div class="line"><span class="comment">//   with Chrono and Simulink. The SimHydraulics toolbox</span></div><div class="line"><span class="comment">//   of Simulink is used here to simulate an hydraulic</span></div><div class="line"><span class="comment">//   circuit that interacts with a Chrono mechanism.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//   This example needs test_cosim_hydraulics.mdl to be</span></div><div class="line"><span class="comment">//   loaded and run in Simulink</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//       CHRONO</span></div><div class="line"><span class="comment">//   ------</span></div><div class="line"><span class="comment">//   Multibody dinamics engine</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// ------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="preprocessor">#include &quot;chrono/core/ChLog.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;chrono/physics/ChSystem.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;chrono_cosimulation/ChCosimulation.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;chrono_cosimulation/ChExceptionSocket.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacechrono.html">chrono</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacechrono_1_1cosimul.html">chrono::cosimul</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div><div class="line">    <span class="comment">// To write something to the console, use the chrono::GetLog()</span></div><div class="line"></div><div class="line">    <a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot;CHRONO SimHydraulics cosimulation \n\n&quot;</span>;</div><div class="line">    <a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot;NOTE! This requires a copy of Simulink with SimHydraulics. \n\n&quot;</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        <span class="comment">// Test</span></div><div class="line">        <span class="comment">// Create a cosimulation interface for simulating an hydraulic</span></div><div class="line">        <span class="comment">// system in Simulink, connected to a mechanical system in</span></div><div class="line">        <span class="comment">// Chrono::Engine.</span></div><div class="line">        <span class="comment">// It requires a license of the SimScape/SimHydraulics Matlab toolbox.</span></div><div class="line"></div><div class="line">        <span class="comment">// 1) Create a very simple ChronoEngine system, without user interface</span></div><div class="line"></div><div class="line">        <span class="comment">// The physical system: it contains all physical objects.</span></div><div class="line">        <a class="code" href="classchrono_1_1_ch_system.html">ChSystem</a> my_system;</div><div class="line"></div><div class="line">        <span class="comment">// Create rigid bodies and add them to the system:</span></div><div class="line">        <span class="keyword">auto</span> my_body_A = std::make_shared&lt;ChBody&gt;();  <span class="comment">// truss</span></div><div class="line">        my_body_A-&gt;SetBodyFixed(<span class="keyword">true</span>);          <span class="comment">// truss does not move!</span></div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_assembly.html#aeb86b4df59dc82ad4d5a969b45e159b1">AddBody</a>(my_body_A);</div><div class="line"></div><div class="line">        <span class="keyword">auto</span> my_body_B = std::make_shared&lt;ChBody&gt;();  <span class="comment">// moving body</span></div><div class="line">        my_body_B-&gt;SetMass(114);</div><div class="line">        my_body_B-&gt;SetInertiaXX(ChVector&lt;&gt;(50, 50, 50));</div><div class="line">        my_body_B-&gt;SetPos(ChVector&lt;&gt;(1, 1, 0));</div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_assembly.html#aeb86b4df59dc82ad4d5a969b45e159b1">AddBody</a>(my_body_B);</div><div class="line"></div><div class="line">        <span class="comment">// Now create a mechanical link (a revolute joint in 0,0,0)</span></div><div class="line">        <span class="comment">// between these two markers, and insert in system:</span></div><div class="line">        <span class="keyword">auto</span> my_link_BA = std::make_shared&lt;ChLinkLockRevolute&gt;();</div><div class="line">        my_link_BA-&gt;Initialize(my_body_B, my_body_A, <a class="code" href="classchrono_1_1_ch_coordsys.html">ChCoordsys&lt;&gt;</a>(ChVector&lt;&gt;(0, 1, 0)));</div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_assembly.html#a5f77de6ceee04f99319b0c8014016083">AddLink</a>(my_link_BA);</div><div class="line"></div><div class="line">        <span class="comment">// Now create a &#39;dead&#39; linear actuator between two points using a</span></div><div class="line">        <span class="comment">// ChLinkSpring with zero stiffness and damping. This will</span></div><div class="line">        <span class="comment">// be used to apply the force between the two bodies as a</span></div><div class="line">        <span class="comment">// cylinder with spherical ball ends.</span></div><div class="line">        <span class="keyword">auto</span> my_link_actuator = std::make_shared&lt;ChLinkSpring&gt;();</div><div class="line">        my_link_actuator-&gt;Initialize(my_body_B, my_body_A, <span class="keyword">false</span>, ChVector&lt;&gt;(1, 0, 0), ChVector&lt;&gt;(1, 1, 0));</div><div class="line">        my_link_actuator-&gt;Set_SpringK(0);</div><div class="line">        my_link_actuator-&gt;Set_SpringR(0);</div><div class="line">        my_link_actuator-&gt;Set_SpringRestLength(my_link_actuator-&gt;GetDist());</div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_assembly.html#a5f77de6ceee04f99319b0c8014016083">AddLink</a>(my_link_actuator);</div><div class="line"></div><div class="line">        <span class="comment">// Create also a spring-damper to have some load when moving:</span></div><div class="line">        <span class="keyword">auto</span> my_link_springdamper = std::make_shared&lt;ChLinkSpring&gt;();</div><div class="line">        my_link_springdamper-&gt;Initialize(my_body_B, my_body_A, <span class="keyword">false</span>, ChVector&lt;&gt;(1, 0, 0), ChVector&lt;&gt;(1, 1, 0));</div><div class="line">        my_link_springdamper-&gt;Set_SpringK(4450);</div><div class="line">        my_link_springdamper-&gt;Set_SpringR(284);</div><div class="line">        my_link_springdamper-&gt;Set_SpringRestLength(my_link_springdamper-&gt;GetDist());</div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_assembly.html#a5f77de6ceee04f99319b0c8014016083">AddLink</a>(my_link_springdamper);</div><div class="line"></div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_system.html#ac78a9f05e1c01223402271e865e489e4">Set_G_acc</a>(ChVector&lt;&gt;(0, 0, 0));</div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_system.html#a0fec5297a93785df11a4dd5409346f2c">SetMaxItersSolverSpeed</a>(20);</div><div class="line">        my_system.<a class="code" href="classchrono_1_1_ch_system.html#a8420bd0eed767607295d15092302ffc9">SetSolverType</a>(ChSystem::SOLVER_BARZILAIBORWEIN);</div><div class="line"></div><div class="line">        <span class="comment">// 2) Add a socket framework object</span></div><div class="line">        <a class="code" href="classchrono_1_1cosimul_1_1_ch_socket_framework.html">ChSocketFramework</a> socket_tools;</div><div class="line"></div><div class="line">        <span class="comment">// 3) Create the cosimulation interface:</span></div><div class="line"></div><div class="line">        <a class="code" href="classchrono_1_1cosimul_1_1_ch_cosimulation.html">ChCosimulation</a> cosimul_interface(socket_tools,</div><div class="line">                                         1,   <span class="comment">// n.input values from Simulink</span></div><div class="line">                                         2);  <span class="comment">// n.output values to Simulink</span></div><div class="line"></div><div class="line">        <span class="comment">// Prepare the two column vectors of data that will be swapped</span></div><div class="line">        <span class="comment">// back and forth between Chrono and Simulink. In detail we will</span></div><div class="line">        <span class="comment">// - receive 1 variable from Simulink (the hydraulic cylinder force)</span></div><div class="line">        <span class="comment">// - send 2 variables to Simulink (the hydraulic cylinder velocity and displacement)</span></div><div class="line">        <a class="code" href="classchrono_1_1_ch_matrix_dynamic.html">ChMatrixDynamic&lt;double&gt;</a> data_in(1, 1);</div><div class="line">        <a class="code" href="classchrono_1_1_ch_matrix_dynamic.html">ChMatrixDynamic&lt;double&gt;</a> data_out(2, 1);</div><div class="line"></div><div class="line">        <span class="comment">// 4) Wait client (Simulink) to connect...</span></div><div class="line"></div><div class="line">        <a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot; *** Waiting Simulink to start... *** \n     (load &#39;data/cosimulation/test_cosim_hydraulics.mdl&#39; &quot;</span></div><div class="line">                    <span class="stringliteral">&quot;in Simulink and press Start...)\n\n&quot;</span>;</div><div class="line"></div><div class="line">        <span class="keywordtype">int</span> PORTNUM = 50009;</div><div class="line"></div><div class="line">        cosimul_interface.WaitConnection(PORTNUM);</div><div class="line"></div><div class="line">        <span class="keywordtype">double</span> mytime = 0;</div><div class="line">        <span class="keywordtype">double</span> histime = 0;</div><div class="line"></div><div class="line">        <span class="comment">// Here the &#39;dt&#39; must be the same of the sampling period that is</span></div><div class="line">        <span class="comment">// entered in the CEcosimulation block</span></div><div class="line"></div><div class="line">        <span class="keywordtype">double</span> dt = 0.001;</div><div class="line"></div><div class="line">        <span class="comment">// 5) Run the co-simulation</span></div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div><div class="line">            <span class="comment">// A) ----------------- ADVANCE THE Chrono SIMULATION</span></div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (dt &gt; 0)</div><div class="line">                my_system.<a class="code" href="classchrono_1_1_ch_system.html#a552f40a0951fa8dc3c1e00900fd3b48c">DoStepDynamics</a>(dt);</div><div class="line"></div><div class="line">            mytime += dt;</div><div class="line"></div><div class="line">            <span class="comment">// B) ----------------- SYNCHRONIZATION</span></div><div class="line"></div><div class="line">            <span class="comment">// B.1) - SEND data</span></div><div class="line"></div><div class="line">            <span class="comment">// - Set the Chrono variables into the vector that must</span></div><div class="line">            <span class="comment">//   be sent to Simulink at the next timestep:</span></div><div class="line">            <span class="comment">//      * the velocity of the hydraulic actuator</span></div><div class="line">            <span class="comment">//      * the displacement of the hydraulic actuator</span></div><div class="line"></div><div class="line">            data_out(0) = my_link_actuator-&gt;GetDist_dt();</div><div class="line">            data_out(1) = my_link_actuator-&gt;GetDist() -</div><div class="line">                          my_link_actuator-&gt;Get_SpringRestLength();  <span class="comment">// subtract initial length so starts at 0.</span></div><div class="line"></div><div class="line">            <span class="comment">// GetLog() &lt;&lt; &quot;Send \n&quot;;</span></div><div class="line">            cosimul_interface.SendData(mytime, &amp;data_out);  <span class="comment">// --&gt; to Simulink</span></div><div class="line"></div><div class="line">            <span class="comment">// B.2) - RECEIVE data</span></div><div class="line"></div><div class="line">            <span class="comment">// GetLog() &lt;&lt; &quot;Receive \n&quot;;</span></div><div class="line">            cosimul_interface.ReceiveData(histime, &amp;data_in);  <span class="comment">// &lt;-- from Simulink</span></div><div class="line"></div><div class="line">            <span class="comment">// - Update the Chrono system with the force value that we received</span></div><div class="line">            <span class="comment">//   from Simulink using the data_in vector, that contains:</span></div><div class="line">            <span class="comment">//      * the force of the hydraulic actuator</span></div><div class="line"></div><div class="line">            my_link_actuator-&gt;Set_SpringF(data_in(0));</div><div class="line"></div><div class="line">            <a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot;--- time: &quot;</span> &lt;&lt; mytime &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">    } <span class="keywordflow">catch</span> (<a class="code" href="classchrono_1_1cosimul_1_1_ch_exception_socket.html">ChExceptionSocket</a> exception) {</div><div class="line">        <a class="code" href="namespacechrono.html#a4fba60cf9a29db628ad96a88b60b4e00">GetLog</a>() &lt;&lt; <span class="stringliteral">&quot; ERRROR with socket system: \n&quot;</span> &lt;&lt; exception.what() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
Generated on Mon Aug 1 2016 15:43:10 for Project Chrono by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11 . <a href="mailto:info@projectchrono.org">Contact us</a> for issues related to this page. 
</small></address>
</body>
</html>
